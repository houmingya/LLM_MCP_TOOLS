# 配置指南

本文档说明如何配置 LLM MCP Tools 系统的各项参数。

## 📋 配置方法

项目使用 **环境变量** 方式管理配置，支持两种配置方式：

### 方式一：使用 .env 文件（推荐）

1. **复制模板文件**
   ```bash
   cp .env.example .env
   ```

2. **编辑 .env 文件**
   ```bash
   # Windows
   notepad .env
   
   # Linux/Mac
   vim .env
   ```

3. **填入你的配置值**（见下方详细说明）

### 方式二：直接设置环境变量

```bash
# Windows (PowerShell)
$env:LLM_API_KEY="your_api_key"

# Linux/Mac (Bash)
export LLM_API_KEY="your_api_key"
```

---

## 🔑 必填配置

### 1. 大模型 API Key（必须配置）

```ini
# 通义千问 API Key
LLM_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxx
```

**获取方式：**
1. 访问 [阿里云百炼平台](https://dashscope.console.aliyun.com/)
2. 注册/登录账号
3. 进入 [API Key 管理](https://dashscope.console.aliyun.com/apiKey)
4. 创建新的 API Key
5. 复制到 `.env` 文件中

**注意：** 
- 新注册用户通常有免费额度
- 请妥善保管 API Key，不要泄露或提交到 Git

---

## ⚙️ 可选配置

### 2. 大模型设置

```ini
# API 基础URL（默认：通义千问）
LLM_API_BASE=https://dashscope.aliyuncs.com/compatible-mode/v1

# 模型名称（可选值见下方）
LLM_MODEL_NAME=qwen-plus

# Embedding 模型
LLM_EMBEDDING_MODEL=text-embedding-v3

# 模型参数
LLM_TEMPERATURE=0.7      # 温度（0-1），越高越随机
LLM_MAX_TOKENS=2000      # 最大输出token数
```

**支持的模型：**
- `qwen-turbo` - 快速响应，适合简单任务
- `qwen-plus` - 平衡性能和成本（推荐）
- `qwen-max` - 最强性能，适合复杂任务

### 3. 数据库配置（可选）

如果不使用数据库工具，可以跳过此部分。

```ini
DB_HOST=localhost          # 数据库主机
DB_PORT=3306              # 数据库端口
DB_USER=root              # 数据库用户名
DB_PASSWORD=your_password # 数据库密码
DB_DATABASE=test_db       # 数据库名称
DB_CHARSET=utf8mb4        # 字符集
```

**数据库准备：**
```sql
-- 创建数据库
CREATE DATABASE test_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建示例表（可选）
USE test_db;

CREATE TABLE employees (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    department_id INT,
    salary DECIMAL(10, 2),
    hire_date DATE
);

CREATE TABLE departments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    manager VARCHAR(100)
);
```

### 4. 服务端口配置

```ini
# Web 应用端口
WEB_HOST=0.0.0.0
WEB_PORT=8000
WEB_RELOAD=true

# MCP Server 端口
MCP_HOST=0.0.0.0
MCP_PORT=8001
```

**端口说明：**
- `WEB_PORT`: 用户访问的 Web 界面端口
- `MCP_PORT`: MCP Server 的内部通信端口
- 确保这两个端口未被占用

### 5. 向量数据库配置

```ini
VECTOR_DB_COLLECTION=documents        # 集合名称
VECTOR_DB_TOP_K=5                    # 检索返回数量
VECTOR_DB_SIMILARITY_THRESHOLD=0.7    # 相似度阈值
```

### 6. 其他配置

```ini
# 天气 API（可选）
WEATHER_API_KEY=

# 日志级别（DEBUG, INFO, WARNING, ERROR）
LOG_LEVEL=INFO
```

---

## 🔍 配置验证

创建测试文件 `test_config.py`：

```python
from config.settings import LLMConfig, DatabaseConfig, WebConfig

# 测试配置加载
print("=" * 50)
print("配置加载测试")
print("=" * 50)

# 检查 LLM 配置
print(f"\n✅ LLM API Key: {'已配置' if LLMConfig.API_KEY else '❌ 未配置'}")
print(f"✅ LLM API Base: {LLMConfig.API_BASE}")
print(f"✅ LLM Model: {LLMConfig.MODEL_NAME}")

# 检查数据库配置
print(f"\n✅ DB Host: {DatabaseConfig.HOST}")
print(f"✅ DB Port: {DatabaseConfig.PORT}")
print(f"✅ DB User: {DatabaseConfig.USER}")
print(f"✅ DB Password: {'已配置' if DatabaseConfig.PASSWORD else '未配置（可选）'}")

# 检查服务配置
print(f"\n✅ Web Port: {WebConfig.PORT}")
print(f"✅ Web Host: {WebConfig.HOST}")

print("\n" + "=" * 50)
if LLMConfig.API_KEY:
    print("✅ 配置验证通过！可以启动服务了。")
else:
    print("❌ 请先配置 LLM_API_KEY")
print("=" * 50)
```

运行测试：
```bash
python test_config.py
```

---

## 🛡️ 安全建议

### ✅ DO（推荐做法）

1. ✅ 使用 `.env` 文件管理敏感配置
2. ✅ 确保 `.env` 在 `.gitignore` 中
3. ✅ 定期更换 API Key
4. ✅ 使用环境变量在生产环境部署
5. ✅ 为不同环境使用不同的配置（开发/测试/生产）

### ❌ DON'T（禁止做法）

1. ❌ 不要在代码中硬编码 API Key
2. ❌ 不要将 `.env` 文件提交到 Git
3. ❌ 不要在公开场合分享配置文件截图
4. ❌ 不要使用弱密码
5. ❌ 不要在生产环境使用 DEBUG 模式

---

## 🚀 不同场景的配置示例

### 场景 1：最小化配置（仅聊天功能）

```ini
# 只配置 LLM，不使用数据库和知识图谱
LLM_API_KEY=sk-xxxxx
LLM_MODEL_NAME=qwen-plus
```

### 场景 2：完整功能配置

```ini
# LLM 配置
LLM_API_KEY=sk-xxxxx
LLM_MODEL_NAME=qwen-plus

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_DATABASE=test_db

# 服务端口
WEB_PORT=8000
MCP_PORT=8001
```

### 场景 3：生产环境配置

```ini
# LLM 配置
LLM_API_KEY=sk-xxxxx
LLM_MODEL_NAME=qwen-max
LLM_TEMPERATURE=0.5
LLM_MAX_TOKENS=4000

# 数据库配置（生产库）
DB_HOST=prod-db.example.com
DB_PORT=3306
DB_USER=app_user
DB_PASSWORD=strong_password_here
DB_DATABASE=prod_db

# 服务配置
WEB_HOST=0.0.0.0
WEB_PORT=80
WEB_RELOAD=false
LOG_LEVEL=WARNING
```

---

## 📞 问题排查

### 问题 1: "LLM_API_KEY not found"

**原因：** 未配置 API Key 或 `.env` 文件未加载

**解决：**
1. 确认 `.env` 文件存在于项目根目录
2. 确认 `LLM_API_KEY` 已填写
3. 重启应用

### 问题 2: 数据库连接失败

**原因：** 数据库配置错误或数据库服务未启动

**解决：**
1. 检查数据库是否运行：`mysql -u root -p`
2. 验证配置参数（主机、端口、用户名、密码）
3. 确认数据库已创建
4. 检查防火墙设置

### 问题 3: 端口被占用

**原因：** 配置的端口被其他程序占用

**解决：**
```bash
# Windows 查看端口占用
netstat -ano | findstr :8000

# Linux/Mac 查看端口占用
lsof -i :8000

# 修改 .env 中的端口配置
WEB_PORT=8080
MCP_PORT=8081
```

---

## 📚 相关资源

- [通义千问文档](https://help.aliyun.com/zh/dashscope/)
- [FastAPI 配置管理](https://fastapi.tiangolo.com/advanced/settings/)
- [python-dotenv 文档](https://github.com/theskumar/python-dotenv)
- [MySQL 安装教程](https://dev.mysql.com/doc/mysql-installation-excerpt/8.0/en/)

---

## 💡 高级技巧

### 多环境配置

创建不同的环境文件：
- `.env` - 本地开发
- `.env.test` - 测试环境
- `.env.prod` - 生产环境

加载指定环境：
```python
from dotenv import load_dotenv

# 加载测试环境配置
load_dotenv('.env.test')
```

### 配置验证

添加配置验证逻辑：
```python
class LLMConfig:
    API_KEY: str = os.getenv("LLM_API_KEY", "")
    
    @classmethod
    def validate(cls):
        if not cls.API_KEY:
            raise ValueError("LLM_API_KEY 必须配置")
        if not cls.API_KEY.startswith("sk-"):
            raise ValueError("LLM_API_KEY 格式不正确")

# 启动时验证
LLMConfig.validate()
```

---

**如有其他配置问题，请提 Issue 或查看 [FAQ](README.md#常见问题)**
